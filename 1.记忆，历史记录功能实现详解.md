# LangGraph 聊天应用 - 记忆功能实现详解

## 实现步骤

### 3.1 第一步:初始化数据库


**代码位置:** [chatbot.ts：16-17](../app/agent/chatbot.ts#L16-L17)

```typescript
const dbPath = path.resolve(process.cwd(), 'chat_history.db');
export const db = new Database(dbPath);
```

### 3.2 第二步:创建检查点保存器

**代码位置:** [chatbot.ts:96-109](../app/agent/chatbot.ts#L96-L109)

```typescript
export const getCheckpointer = () => {
  if (!checkpointer) {
    // 创建 SQLite 检查点保存器
    console.log('初始化 SqliteSaver,数据库路径:', dbPath);
    try {
      // 初始化自定义 sessions 表
      initSessionTable();
      checkpointer = new SqliteSaver(db);
      console.log('SqliteSaver 初始化成功');
    } catch (error) {
      console.error('SqliteSaver 初始化失败:', error);
      throw error;
    }
  }
  return checkpointer;
};
```

### 3.3 第三步:将检查点保存器绑定到状态图

**代码位置:** [chatbot.ts:135-136](../app/agent/chatbot.ts#L135-L136)

```typescript
if (!app) {
  app = workflow.compile({ checkpointer });
}
```

### 3.4 第四步:发送消息时指定会话 ID

**代码位置:** [route.ts:53-54](../app/api/chat/route.ts#L53-L54)

```typescript
const threadId =
  typeof thread_id === 'string' && thread_id ? thread_id : randomUUID();
const threadConfig = { configurable: { thread_id: threadId } };
```

### 3.5 第五步:流式响应时自动保存

**代码位置:** [route.ts:102-122](../app/api/chat/route.ts#L102-L122)

```typescript
// 使用 streamEvents 获取流式响应
for await (const event of app.streamEvents(
  { messages: [userMessage] },
  { version: 'v2', ...threadConfig } // ← 传入 thread_id
)) {
  if (event.event === 'on_chat_model_stream') {
    const chunk = event.data?.chunk;
    if (chunk?.content) {
      const data =
        JSON.stringify({
          type: 'chunk',
          content: chunk.content,
        }) + '\n';
      controller.enqueue(new TextEncoder().encode(data));
    }
  }
}
```
### 3.6 第六步:加载历史消息

**代码位置:** [route.ts:208-248](../app/api/chat/route.ts#L208-L248)

```typescript
export async function GET(request: NextRequest) {
  const { searchParams } = new URL(request.url);
  const thread_id = searchParams.get('thread_id');

  if (thread_id) {
    try {
      const app = await getApp();

      // 通过 graph.getState 获取历史
      const state = await app.getState({
        configurable: { thread_id },
      });

      return NextResponse.json({
        thread_id,
        history: state?.values?.messages || [],
      });
    } catch (e) {
      return NextResponse.json(
        { error: '获取历史记录失败', detail: String(e) },
        { status: 500 }
      );
    }
  }
}
```